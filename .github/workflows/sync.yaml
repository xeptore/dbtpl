name: Sync Tags

on:
  schedule:
    # https://crontab.guru/
    - cron: "0 * * * *"
  push:
    branches:
      - main

# permissions:
#   contents: none
#   deployments: none
#   actions: none
#   checks: none
#   discussions: none
#   id-token: none
#   issues: none
#   packages: none
#   pages: none
#   pull-requests: none
#   repository-projects: none
#   security-events: none
#   statuses: none
#   attestations: none
#   models: none

concurrency:
  group: ${{ github.workflow }}/${{ github.ref_type }}/${{ github.ref_name }}
  cancel-in-progress: true

jobs:
  sync-tags:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v5
        with:
          submodules: recursive
          fetch-depth: 0
          path: current
          clean: true
          fetch-tags: true
          show-progress: true

      - name: Checkout Upstream Repo
        uses: actions/checkout@v5
        with:
          repository: xo/dbtpl
          submodules: recursive
          fetch-depth: 0
          fetch-tags: true
          path: upstream
          clean: true
          show-progress: true

      - name: Filter Upstream Tags
        shell: bash
        working-directory: upstream
        run: |-
          set -Eeuo pipefail

          cutoff="2024-01-01T00:00:00Z"

          git for-each-ref \
            --sort=creatordate \
            --format='%(refname:short) %(creatordate:iso-strict)' \
            refs/tags \
            | awk -v c="$cutoff" '$2 >= c {print $1, $2}' > ../tags.txt

      - name: Mirror Tags
        shell: bash
        working-directory: current
        run: |-
          set -Eeuo pipefail

          if [[ ! -s ../tags.txt ]]; then
            echo "::notice::No upstream tags newer than cutoff."
            exit 0
          fi

          while read -r tag date; do
            ns="upstream/${tag}"
            if git ls-remote --tags origin "refs/tags/${ns}" | grep -q .; then
              echo "::notice::✓ Already mirrored: $ns"
              continue
            fi

            sha=$(cd ../upstream && git rev-list -n 1 "${tag}" 2>/dev/null || true)
            if [[ -z "$sha" ]]; then
              echo "::warning::⚠️  Unable to resolve tag '$tag' in upstream"
              continue
            fi

            # fetch that object into the current repo so we can reference it
            git fetch ../upstream "$sha" >/dev/null 2>&1 || true

            # now create the namespaced tag
            if git cat-file -e "$sha" 2>/dev/null; then
              git tag -f "$ns" "$sha"
              git push -f origin "refs/tags/${ns}:refs/tags/${ns}"
              echo "::notice title=Tag pushed::$ns → $sha ($date)"
            else
              echo "::warning::⚠️  Skipped $tag (object not fetched properly)"
            fi
          done < ../tags.txt

          echo "::endgroup::"

      - name: Done
        run: echo "::notice::✅ Tag synchronization complete."
